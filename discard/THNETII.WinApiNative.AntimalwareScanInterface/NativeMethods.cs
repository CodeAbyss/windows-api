using System.Runtime.InteropServices;

namespace THNETII.WinApiNative.AntimalwareScanInterface
{
    using static AMSI_RESULT;

    /// <summary>
    /// Declares the native functions to use with the Antimalware Scan Interface technology in the Windows API
    /// </summary>
    /// <remarks>
    /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/_amsi/">Antimalware Scan Interface</a></para>
    /// </remarks>
    public static class NativeMethods
    {
        private const string AmsiDll = "Amsi.dll";

        #region AmsiCloseSession function
        /// <summary>
        /// Close a session that was opened by <see cref="AmsiOpenSession"/>.
        /// </summary>
        /// <param name="amsiContext">The AMSI Context handle that was initially received from <see cref="AmsiInitialize"/>.</param>
        /// <param name="amsiSession">The AMSI Session handle that was initially received from <see cref="AmsiOpenSession"/>.</param>
        /// <remarks>
        /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiclosesession">AmsiCloseSession function</a></para>
        /// </remarks>
        /// <seealso cref="AmsiInitialize"/>
        /// <seealso cref="AmsiOpenSession"/>
        [DllImport(AmsiDll, CallingConvention = CallingConvention.StdCall)]
        public static extern void AmsiCloseSession(
            [In] HAMSICONTEXT amsiContext,
            [In] HAMSISESSION amsiSession
            );
        #endregion
        #region AmsiInitialize function
        /// <summary>
        /// Initialize the AMSI API.
        /// </summary>
        /// <param name="appName">The name, version, or GUID string of the app calling the AMSI API.</param>
        /// <returns>
        /// The AMSI Context handle that must be passed to all subsequent calls to the AMSI API.
        /// </returns>
        /// <remarks>
        /// When the app is finished with the AMSI API it must call <see cref="AmsiUninitialize"/>.
        /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiinitialize">AmsiInitialize function</a></para>
        /// </remarks>
        /// <seealso cref="AmsiUninitialize"/>
        [DllImport(AmsiDll, CallingConvention = CallingConvention.StdCall, PreserveSig = false)]
        public static extern HAMSICONTEXT AmsiInitialize(
            [In, MarshalAs(UnmanagedType.LPWStr)] string appName
            );
        #endregion
        #region AmsiOpenSession function
        /// <summary>
        /// Opens a session within which multiple scan requests can be correlated.
        /// </summary>
        /// <param name="amsiContext">The AMSI Context handle that was initially received from <see cref="AmsiInitialize"/>.</param>
        /// <returns>
        /// AMSI Session handle that must be passed to all subsequent calls to the AMSI API within the session.
        /// </returns>
        /// <remarks>
        /// When the app is finished with the session it must call <see cref="AmsiCloseSession"/>.
        /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiopensession">AmsiOpenSession function</a></para>
        /// </remarks>
        /// <seealso cref="AmsiCloseSession"/>
        /// <seealso cref="AmsiInitialize"/>
        [DllImport(AmsiDll, CallingConvention = CallingConvention.StdCall, PreserveSig = false)]
        public static extern HAMSISESSION AmsiOpenSession(
            [In] HAMSICONTEXT amsiContext
            );
        #endregion
        #region AmsiResultIsBlockedByAdmin
        /// <summary />
        public static bool AmsiResultIsBlockedByAdmin(this AMSI_RESULT r) =>
            r >= AMSI_RESULT_BLOCKED_BY_ADMIN_START && r <= AMSI_RESULT_BLOCKED_BY_ADMIN_END;
        #endregion
        #region AmsiResultIsMalware macro
        /// <summary>
        /// Determines if the result of a scan indicates that the content should be blocked.
        /// </summary>
        /// <param name="r">The <see cref="AMSI_RESULT"/> returned by <see cref="AmsiScanBuffer"/> or <see cref="AmsiScanString"/>.</param>
        /// <returns><c>true</c> if <paramref name="r"/> indicates that malware was detected; otherwise, <c>false</c>.</returns>
        /// <remarks>
        /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiresultismalware">AmsiResultIsMalware macro</a></para>
        /// </remarks>
        /// <seealso cref="AMSI_RESULT"/>
        /// <seealso cref="AmsiScanBuffer"/>
        /// <seealso cref="AmsiScanString"/>
        public static bool AmsiResultIsMalware(this AMSI_RESULT r) =>
            r >= AMSI_RESULT_DETECTED;
        #endregion
        #region AmsiScanBuffer function
        /// <summary>
        /// Scans a buffer-full of content for malware.
        /// </summary>
        /// <param name="amsiContext">The AMSI Context handle that was initially received from <see cref="AmsiInitialize"/>.</param>
        /// <param name="buffer">The buffer from which to read the data to be scanned.</param>
        /// <param name="length">The length, in bytes, of the data to be read from <paramref name="buffer"/>.</param>
        /// <param name="contentName">The filename, URL, unique script ID, or similar of the content being scanned.</param>
        /// <param name="amsiSession">
        /// If multiple scan requests are to be correlated within a session,
        /// set <paramref name="amsiSession"/> to the handle that was initially
        /// received from <see cref="AmsiOpenSession"/>. Otherwise, omit <paramref name="amsiSession"/>
        /// or set it to <c>null</c>.
        /// </param>
        /// <returns>
        /// <para>The result of the scan. See <see cref="AMSI_RESULT"/>.</para>
        /// <para>An app should use <see cref="AmsiResultIsMalware"/> to determine whether the content should be blocked.</para>
        /// </returns>
        /// <remarks>
        /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiscanbuffer">AmsiScanBuffer function</a></para>
        /// </remarks>
        /// <seealso cref="AMSI_RESULT"/>
        /// <seealso cref="AmsiInitialize"/>
        /// <seealso cref="AmsiOpenSession"/>
        /// <seealso cref="AmsiResultIsMalware"/>
        [DllImport(AmsiDll, CallingConvention = CallingConvention.StdCall, PreserveSig = false)]
        public static extern AMSI_RESULT AmsiScanBuffer(
            [In] HAMSICONTEXT amsiContext,
            [In, MarshalAs(UnmanagedType.LPArray, SizeParamIndex = 2)] byte[] buffer,
            [In] int length,
            [In, Optional, MarshalAs(UnmanagedType.LPWStr)] string contentName,
            [In, Optional] HAMSISESSION amsiSession
            );
        #endregion
        #region AmsiScanString function
        /// <summary>
        /// Scans a string for malware.
        /// </summary>
        /// <param name="amsiContext">The AMSI Context handle that was initially received from <see cref="AmsiInitialize"/>.</param>
        /// <param name="string">The string to be scanned.</param>
        /// <param name="contentName">The filename, URL, unique script ID, or similar of the content being scanned.</param>
        /// <param name="amsiSession">
        /// If multiple scan requests are to be correlated within a session,
        /// set <paramref name="amsiSession"/> to the handle that was initially
        /// received from <see cref="AmsiOpenSession"/>. Otherwise, omit <paramref name="amsiSession"/>
        /// or set it to <c>null</c>.
        /// </param>
        /// <returns>
        /// <para>The result of the scan. See <see cref="AMSI_RESULT"/>.</para>
        /// <para>An app should use <see cref="AmsiResultIsMalware"/> to determine whether the content should be blocked.</para>
        /// </returns>
        /// <remarks>
        /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiscanstring">AmsiScanString function</a></para>
        /// </remarks>
        /// <seealso cref="AMSI_RESULT"/>
        /// <seealso cref="AmsiInitialize"/>
        /// <seealso cref="AmsiOpenSession"/>
        /// <seealso cref="AmsiResultIsMalware"/>
        [DllImport(AmsiDll, CallingConvention = CallingConvention.StdCall, PreserveSig = false)]
        public static extern AMSI_RESULT AmsiScanString(
            [In] HAMSICONTEXT amsiContext,
            [In, MarshalAs(UnmanagedType.LPWStr)] string @string,
            [In, Optional, MarshalAs(UnmanagedType.LPWStr)] string contentName,
            [In, Optional] HAMSISESSION amsiSession
            );
        #endregion
        #region AmsiUninitialize function
        /// <summary>
        /// Remove the instance of the AMSI API that was originally opened by <see cref="AmsiInitialize"/>.
        /// </summary>
        /// <param name="amsiContext">The AMSI Context handle that was initially received from <see cref="AmsiInitialize"/>.</param>
        /// <remarks>
        /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiuninitialize">AmsiUninitialize function</a></para>
        /// </remarks>
        /// <seealso cref="AmsiInitialize"/>
        [DllImport(AmsiDll, CallingConvention = CallingConvention.StdCall)]
        public static extern void AmsiUninitialize(
            [In] HAMSICONTEXT amsiContext
            );
        #endregion
    }
}
