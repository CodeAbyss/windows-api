using System;
using System.Diagnostics.CodeAnalysis;
using THNETII.WinApiNative.AntimalwareScanInterface;

using static THNETII.WinApiNative.AntimalwareScanInterface.NativeMethods;

namespace THNETII.WinApi.AntimalwareScanInterface
{
    [SuppressMessage("Design", "CA1063:Implement IDisposable Correctly")]
    public class AmsiSession : IDisposable
    {
        private HAMSICONTEXT ctx;
        private HAMSISESSION session;

        public static AmsiSession FromHAMSISESSION(HAMSICONTEXT ctx, HAMSISESSION session)
            => new AmsiSession { ctx = ctx, session = session };

        private AmsiSession() : base() { }

        public AmsiResult ScanBuffer(byte[] buffer, string contentName = default) =>
            (AmsiResult)AmsiScanBuffer(ctx, buffer, buffer?.Length ?? 0, contentName, session);

        [SuppressMessage("Naming", "CA1720:Identifier contains type name")]
        public AmsiResult ScanString(string @string, string contentName = default) =>
            (AmsiResult)AmsiScanString(ctx, @string, contentName, session);

        public void Dispose()
        {
            GC.SuppressFinalize(this);
            var session = this.session;
            this.session = default;
            AmsiCloseSession(ctx, session);
        }

        [SuppressMessage("Performance", "CA1821:Remove empty Finalizers")]
        ~AmsiSession() => Dispose();
    }
}
