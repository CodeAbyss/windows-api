using System;
using System.Diagnostics.CodeAnalysis;
using THNETII.WinApiNative.AntimalwareScanInterface;

using static THNETII.WinApiNative.AntimalwareScanInterface.NativeMethods;

namespace THNETII.WinApi.AntimalwareScanInterface
{
    [SuppressMessage("Design", "CA1063:Implement IDisposable Correctly")]
    public class AmsiContext : IDisposable
    {
        private HAMSICONTEXT ctx;

        public static AmsiContext FromHAMSICONTEXT(in HAMSICONTEXT ctx) =>
            new AmsiContext { ctx = ctx };

        private AmsiContext() : base() { }

        public AmsiContext(string appName)
        {
            ctx = AmsiInitialize(appName);
        }

        public AmsiSession OpenSession() =>
            AmsiSession.FromHAMSISESSION(ctx, AmsiOpenSession(ctx));

        public AmsiResult ScanBuffer(byte[] buffer, string contentName = default) =>
            (AmsiResult)AmsiScanBuffer(ctx, buffer, buffer?.Length ?? 0, contentName);

        [SuppressMessage("Naming", "CA1720:Identifier contains type name")]
        public AmsiResult ScanString(string @string, string contentName = default) =>
            (AmsiResult)AmsiScanString(ctx, @string, contentName);

        public void Dispose()
        {
            GC.SuppressFinalize(this);
            var ctx = this.ctx;
            this.ctx = default;
            AmsiUninitialize(ctx);
        }

        [SuppressMessage("Performance", "CA1821:Remove empty Finalizers")]
        ~AmsiContext() => Dispose();
    }
}
