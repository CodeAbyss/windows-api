using System.Runtime.InteropServices;

namespace THNETII.WinApi.Native.AntimalwareScanInterface
{
    /// <summary>
    /// Declares the native functions to use with the Antimalware Scan Interface technology in the Windows API
    /// </summary>
    /// <remarks>
    /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/_amsi/">Antimalware Scan Interface</a></para>
    /// </remarks>
    public static class NativeMethods
    {
        private const string AmsiDll = "Amsi.dll";

        #region AmsiCloseSession function
        /// <summary>
        /// Close a session that was opened by <see cref="AmsiOpenSession"/>.
        /// </summary>
        /// <param name="amsiContext">The AMSI Context handle that was initially received from <see cref="AmsiInitialize"/>.</param>
        /// <param name="amsiSession">The AMSI Session handle that was initially received from <see cref="AmsiOpenSession"/>.</param>
        /// <remarks>
        /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiclosesession">AmsiCloseSession function</a></para>
        /// </remarks>
        /// <seealso cref="AmsiInitialize"/>
        /// <seealso cref="AmsiOpenSession"/>
        [DllImport(AmsiDll, CallingConvention = CallingConvention.StdCall)]
        public static extern void AmsiCloseSession(
            [In] AmsiContext amsiContext,
            [In] AmsiSession amsiSession
            );
        #endregion
        #region AmsiInitialize function
        /// <summary>
        /// Initialize the AMSI API.
        /// </summary>
        /// <param name="appName">The name, version, or GUID string of the app calling the AMSI API.</param>
        /// <param name="amsiContext">Receives the AMSI Context handle that must be passed to all subsequent calls to the AMSI API.</param>
        /// <returns>
        /// If this function succeeds, it returns <see cref="S_OK"/>. Otherwise, it returns an <see cref="HRESULT"/> error code.
        /// </returns>
        /// <remarks>
        /// When the app is finished with the AMSI API it must call <see cref="AmsiUninitialize"/> or <see cref="AmsiContext.Dispose"/> the context returned in the <paramref name="amsiContext"/> parameter.
        /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiinitialize">AmsiInitialize function</a></para>
        /// </remarks>
        /// <seealso cref="AmsiUninitialize"/>
        [return: MarshalAs(UnmanagedType.Error)]
        [DllImport(AmsiDll, CallingConvention = CallingConvention.StdCall)]
        public static extern int AmsiInitialize(
            [In, MarshalAs(UnmanagedType.LPWStr)] string appName,
            out AmsiContext amsiContext
            );
        #endregion
        #region AmsiOpenSession function
        /// <summary>
        /// Opens a session within which multiple scan requests can be correlated.
        /// </summary>
        /// <param name="amsiContext">The AMSI Context handle that was initially received from <see cref="AmsiInitialize"/>.</param>
        /// <param name="amsiSession">Receives the AMSI Session handle that must be passed to all subsequent calls to the AMSI API within the session.</param>
        /// <returns>
        /// If this function succeeds, it returns <see cref="S_OK"/>. Otherwise, it returns an <see cref="HRESULT"/> error code.
        /// </returns>
        /// <remarks>
        /// When the app is finished with the session it must call <see cref="AmsiCloseSession"/>.
        /// <para>Original MSDN documentation page: <a href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiopensession">AmsiOpenSession function</a></para>
        /// </remarks>
        /// <seealso cref="AmsiCloseSession"/>
        /// <seealso cref="AmsiInitialize"/>
        [return: MarshalAs(UnmanagedType.Error)]
        [DllImport(AmsiDll, CallingConvention = CallingConvention.StdCall)]
        public static extern int AmsiOpenSession(
            [In] AmsiContext amsiContext,
            out AmsiSession amsiSession
            );
        #endregion
    }
}
